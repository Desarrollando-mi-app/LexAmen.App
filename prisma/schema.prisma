// LéxAmen — Schema de base de datos
// Plataforma de aprendizaje de Derecho Civil y Procesal Civil (Chile)

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────

enum Plan {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_ANNUAL
}

enum Tipo {
  CIVIL
  PROCESAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

// ─── Modelos ─────────────────────────────────────────────

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  firstName       String
  lastName        String
  age             Int?
  gender          String?
  institution     String?
  universityYear  Int?
  plan            Plan      @default(FREE)
  planExpiresAt   DateTime?
  termsAcceptedAt DateTime?
  termsVersion    String?
  xp              Int       @default(0)
  createdAt       DateTime  @default(now())

  flashcardProgress   UserFlashcardProgress[]
  mcqAttempts         UserMCQAttempt[]
  trueFalseAttempts   UserTrueFalseAttempt[]
  contentReports      ContentReport[]
  subscriptions       Subscription[]
}

model Flashcard {
  id         String  @id @default(cuid())
  front      String
  back       String
  unidad     String  @default("DERECHO_CIVIL_1")
  materia    String
  submateria String
  tipo       Tipo
  nivel      String  @default("BASICO")

  progress UserFlashcardProgress[]
}

model UserFlashcardProgress {
  id             String    @id @default(cuid())
  userId         String
  flashcardId    String
  easeFactor     Float     @default(2.5)
  interval       Int       @default(0)
  repetitions    Int       @default(0)
  nextReviewAt   DateTime  @default(now())
  lastReviewedAt DateTime?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@unique([userId, flashcardId])
}

model MCQ {
  id            String  @id @default(cuid())
  question      String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctOption String
  explanation   String?
  unidad        String  @default("DERECHO_CIVIL_1")
  materia       String
  submateria    String
  tipo          Tipo
  nivel         String  @default("BASICO")

  attempts UserMCQAttempt[]
}

model UserMCQAttempt {
  id             String   @id @default(cuid())
  userId         String
  mcqId          String
  selectedOption String
  isCorrect      Boolean
  attemptedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcq  MCQ  @relation(fields: [mcqId], references: [id], onDelete: Cascade)
}

model TrueFalse {
  id          String  @id @default(cuid())
  statement   String
  isTrue      Boolean
  explanation String?
  unidad      String  @default("DERECHO_CIVIL_1")
  materia     String
  submateria  String
  tipo        String
  nivel       String  @default("BASICO")

  attempts UserTrueFalseAttempt[]
}

model UserTrueFalseAttempt {
  id             String   @id @default(cuid())
  userId         String
  trueFalseId    String
  selectedAnswer Boolean
  isCorrect      Boolean
  attemptedAt    DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  trueFalse TrueFalse @relation(fields: [trueFalseId], references: [id], onDelete: Cascade)
}

model ContentReport {
  id          String   @id @default(cuid())
  userId      String
  contentType String
  contentId   String
  reason      String
  description String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id             String             @id @default(cuid())
  userId         String
  plan           Plan
  amount         Int
  currency       String             @default("CLP")
  status         SubscriptionStatus @default(PENDING)
  transbankToken String?
  createdAt      DateTime           @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
