// LéxAmen — Schema de base de datos
// Plataforma de aprendizaje de Derecho Civil y Procesal Civil (Chile)

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────

enum Plan {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_ANNUAL
}

enum Tipo {
  CIVIL
  PROCESAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum LeagueTier {
  CARTON
  HIERRO
  BRONCE
  COBRE
  PLATA
  ORO
  DIAMANTE
  PLATINO
  JURISCONSULTO
}

enum CausaStatus {
  PENDING
  ACTIVE
  COMPLETED
  REJECTED
  EXPIRED
}

// ─── Modelos ─────────────────────────────────────────────

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  firstName       String
  lastName        String
  age             Int?
  gender          String?
  institution     String?
  universityYear  Int?
  plan            Plan      @default(FREE)
  planExpiresAt   DateTime?
  termsAcceptedAt DateTime?
  termsVersion    String?
  xp              Int       @default(0)
  causasGanadas   Int       @default(0)
  causasPerdidas  Int       @default(0)
  createdAt       DateTime  @default(now())

  flashcardProgress   UserFlashcardProgress[]
  flashcardFavorites  FlashcardFavorite[]
  mcqAttempts         UserMCQAttempt[]
  trueFalseAttempts   UserTrueFalseAttempt[]
  contentReports      ContentReport[]
  curriculumProgress  CurriculumProgress[]
  leagueMembers       LeagueMember[]
  causasRetadas       Causa[]        @relation("CausasRetadas")
  causasRecibidas     Causa[]        @relation("CausasRecibidas")
  causasGanadasRel    Causa[]        @relation("CausasGanadas")
  causaAnswers        CausaAnswer[]
  subscriptions       Subscription[]
}

model Flashcard {
  id         String  @id @default(cuid())
  front      String
  back       String
  unidad     String  @default("DERECHO_CIVIL_1")
  materia    String
  submateria String
  tipo       Tipo
  nivel      String  @default("BASICO")

  progress  UserFlashcardProgress[]
  favorites FlashcardFavorite[]
}

model UserFlashcardProgress {
  id             String    @id @default(cuid())
  userId         String
  flashcardId    String
  easeFactor     Float     @default(2.5)
  interval       Int       @default(0)
  repetitions    Int       @default(0)
  nextReviewAt   DateTime  @default(now())
  lastReviewedAt DateTime?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@unique([userId, flashcardId])
}

model MCQ {
  id            String  @id @default(cuid())
  question      String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctOption String
  explanation   String?
  unidad        String  @default("DERECHO_CIVIL_1")
  materia       String
  submateria    String
  tipo          Tipo
  nivel         String  @default("BASICO")

  attempts     UserMCQAttempt[]
  causaAnswers CausaAnswer[]
}

model UserMCQAttempt {
  id             String   @id @default(cuid())
  userId         String
  mcqId          String
  selectedOption String
  isCorrect      Boolean
  attemptedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcq  MCQ  @relation(fields: [mcqId], references: [id], onDelete: Cascade)
}

model TrueFalse {
  id          String  @id @default(cuid())
  statement   String
  isTrue      Boolean
  explanation String?
  unidad      String  @default("DERECHO_CIVIL_1")
  materia     String
  submateria  String
  tipo        String
  nivel       String  @default("BASICO")

  attempts UserTrueFalseAttempt[]
}

model UserTrueFalseAttempt {
  id             String   @id @default(cuid())
  userId         String
  trueFalseId    String
  selectedAnswer Boolean
  isCorrect      Boolean
  attemptedAt    DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  trueFalse TrueFalse @relation(fields: [trueFalseId], references: [id], onDelete: Cascade)
}

model ContentReport {
  id          String   @id @default(cuid())
  userId      String
  contentType String
  contentId   String
  reason      String
  description String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CurriculumProgress {
  id              String    @id @default(cuid())
  userId          String
  submateria      String
  completions     Int       @default(0)
  lastCompletedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, submateria])
}

// ─── Ligas Semanales ─────────────────────────────────────

model League {
  id        String     @id @default(cuid())
  tier      LeagueTier
  weekStart DateTime
  weekEnd   DateTime
  createdAt DateTime   @default(now())

  members LeagueMember[]

  @@index([tier, weekStart])
}

model LeagueMember {
  id       String @id @default(cuid())
  userId   String
  leagueId String
  weeklyXp Int    @default(0)
  rank     Int?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueId])
  @@index([leagueId, weeklyXp])
}

// ─── Causas (Duelos 1v1) ────────────────────────────────

model Causa {
  id           String      @id @default(cuid())
  challengerId String
  challengedId String
  status       CausaStatus @default(PENDING)
  winnerId     String?
  createdAt    DateTime    @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  challenger User  @relation("CausasRetadas", fields: [challengerId], references: [id], onDelete: Cascade)
  challenged User  @relation("CausasRecibidas", fields: [challengedId], references: [id], onDelete: Cascade)
  winner     User? @relation("CausasGanadas", fields: [winnerId], references: [id], onDelete: SetNull)

  answers CausaAnswer[]

  @@index([challengerId, status])
  @@index([challengedId, status])
}

model CausaAnswer {
  id             String   @id @default(cuid())
  causaId        String
  userId         String
  mcqId          String
  questionIdx    Int
  selectedOption String?
  isCorrect      Boolean?
  timeMs         Int?
  score          Int      @default(0)
  answeredAt     DateTime @default(now())

  causa Causa @relation(fields: [causaId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcq   MCQ   @relation(fields: [mcqId], references: [id], onDelete: Cascade)

  @@unique([causaId, userId, questionIdx])
}

// ─── Flashcard Favoritos ─────────────────────────────────

model FlashcardFavorite {
  id          String   @id @default(cuid())
  userId      String
  flashcardId String
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@unique([userId, flashcardId])
}

// ─── Suscripciones ──────────────────────────────────────

model Subscription {
  id             String             @id @default(cuid())
  userId         String
  plan           Plan
  amount         Int
  currency       String             @default("CLP")
  status         SubscriptionStatus @default(PENDING)
  transbankToken String?
  createdAt      DateTime           @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
